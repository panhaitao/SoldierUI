<html>
  <head>
	  <title>网页模板</title>
	  <meta charset="utf-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1">
	  <!-- <style type="text/css"> </style> -->
	  <link rel="stylesheet" type="text/css" href="css/main.css">
  </head>

<body>
	<head>
	  <div id=top >
	  <div id="headNav">
		<nav>
			<ol>
				<li><a href=/>深蓝笔记</a></li>
				<li><a href=/>ARCHIVERS</a></li> 
				<li><a href=/>TAGS</a></li>      
				<li><a href=/>ABOUT</a></li>     
			</ol>
		  </nav>
		</div>
	  </div>
    </head>

		

	<div id="page">
      <div id="left">

<a id=议题背景></a>
<h1>议题背景</h1>
<p>在客户现场运维的时候，经常面临各种各样的问题，有些甚至是不段重复的机械劳动,这个时候就需要我们想尽办法去偷懒，去达到即快又好的解决问题，又能让自己在客户现场运维的节奏更轻松，更自在些！</p>
<hr>


<a id=主机操作></a>
<h1>主机操作<h1>
<hr>

<a id=查看所有主机运行状态></a>
<h2>查看所有主机运行状态<h2>
<b>ansible all -m shell -a "uptime;mpstat;free" -o</b>
<hr>

<a id=找出分区占用过大的主机></a>
<h2>找出分区占用过大的主机<h2>
执行命令: <b>ansible all -m script -a "check_disk_use.sh" </b>脚本.
check_disk_use.sh 内容
<pre>
#!/bin/bash
df -h  |  awk 'NR>1 { print $5" "$6 }' | while read line
do
    part_use=`echo $line | awk '{print $1}' | awk -F% '{print $1}'`
    part_mount=`echo $line | awk '{print $2}'`
    if [[ ${part_use} -ge 70 ]];then
            echo "       Local Dir $part_mount Usage is over $part_use %  "
    fi
done
</pre>
<hr>

<a id=为所有主机添加SSH-key></a>
<h2>为所有主机添加SSH-key<h2>

执行命令: ansible-playbook add-ssh-key.yaml

<pre>
playbook add-ssh-key.yaml:

- name: add ssh pubkey
  hosts: all
  user: root
  tasks:
  - name: Set authorized key took from file
    authorized_key:
      user: root
      state: present
      key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
</pre>
<hr>

<a id=集群></a>
<h1>集群<h1>
<br>

<a id=批量重启集群内所有服务></a>
<h2>批量重启集群内所有服务<h2>
1. 获取a6_dev_cluster集群中a6-dev项目中的服务总数
<pre>
let NUM=`curl -X "GET" "http://<lb_ip>:20081/v2/services/?cluster=a6_dev_cluster&project_name=a6-dev&page_size=100&num_pages=1" -H 'Authorization:Token 20958ce5dffd231ab5de6a03e9353db016df01b0' | jq '.count'`
</pre>
2. 打印每个服务的对应的名称和UUID

<pre>
for((i=0;i<$NUM;i++))
do
  srv_name=$(curl -X "GET"  "http://<lb_ip>:20081/v2/services/?cluster=a6_dev_cluster&project_name=a6-dev&page_size=100&num_pages=1" -H 'Authorization:Token 20958ce5dffd231ab5de6a03e9353db016df01b0' | jq '.results['$i'].resource.name')
  srv_uuid=$(curl -X "GET"  "http://11.11.174.85:20081/v2/services/?cluster=a6_dev_cluster&project_name=a6-dev&page_size=100&num_pages=1" -H 'Authorization:Token 20958ce5dffd231ab5de6a03e9353db016df01b0' | jq '.results['$i'].resource.uuid')
  echo $srv_name  $srv_uuid
done
</pre>

从以上结果中查询到要操作的服务对应的UUID

3. 停止一个服务 

以运行在 a6-dev 项目中的一个服务UUID为　ea849a05-22ac-4977-9f87-da83714bccaf 的服务为例,对服务进行停止操作：
<pre>
curl -X "PUT" "http://<lb_ip>:20081/v2/services/ea849a05-22ac-4977-9f87-da83714bccaf/stop/?project_name=a6-dev" -H 'Authorization:Token 20958ce5dffd231ab5de6a03e9353db016df01b0'
</pre>

4. 启动一个服务 

以运行在 a6-dev 项目中的一个服务UUID为　ea849a05-22ac-4977-9f87-da83714bccaf 的服务为例,对服务进行停止操作：
<pre>
curl -X "PUT" "http://<lb_ip>:20081/v2/services/ea849a05-22ac-4977-9f87-da83714bccaf/start/?project_name=a6-dev" -H 'Authorization:Token 20958ce5dffd231ab5de6a03e9353db016df01b0'
</pre>
<hr>


<a id=找出集群内的特定pod并重建></a>
<h2>找出集群内的特定pod并重建<h2>

在中油项目的时候，当时有这样一个场景，客户切换了数据集群，IP发生变化，当变更了为微服务配置中心配置后，重启了大部分pod，但是要找到对旧数据库IP依旧保持连接的那些pod，找到并更新

<pre>
#!/bin/bash
ns=$1
for pod in `kubectl get pods -n $ns | awk '{print $1}'`
do
    kubectl exec -t  -i -n $ns $pod  -- sh -c "netstat | grep 11.11.157.138"  &> /dev/null
    if [[ "$?" == "0" ]];then
    　echo " $pod of $ns will be rebuid "
      kubectl delete pods $pod -n $ns
    fi
done
</pre>
<hr>


<a id=启/停部分节点的日志服务></a>
<h2>启/停部分节点的日志服务<h2>


enable-dd-agent.yaml
<pre>
- name: dd-agent
  hosts: group_name
  tasks:
  - name:  remove disabled-dd-agent crond tasks
    shell: "rm -f /etc/cron.d/dd-agent" 
  - name: restart crond service
    shell: "systemctl restart crond" 
</pre>


disabled-dd-agent.yaml
<pre>
- name: dd-agent
  hosts: group_name
  tasks:
  - name:  add disabled-dd-agent /etc/cron.d
    cron:
      name: disbled dd-agent 
      minute: "*/1"
      user: root
      job: "docker rm dd-agent spectre_3.2 -f &> /dev/null"
      cron_file: dd-agent
  - name: restart crond service
    shell: "systemctl restart crond" 
</pre>

停用　dd-agent　监控组件 ansible-palybook disabled-dd-agent.yaml
启用　dd-agent　监控组件　ansible-palybook enable-dd-agent.yaml
<hr>


<a id=列出群内所有服务的资源限额配置></a>
<h2>列出群内所有服务的资源限额配置<h2>

在中石油项目上，经常要求被统计各种信息，docker存储配置，各个组件日志配置，甚至是要求统计部署的服务资源限额配置，

<pre>
NS=$1
for DEPLOY in `kubectl get deploy -n $NS | awk '{print $1}'`
do
  limits=`kubectl get deploy $DEPLOY -n $NS -o=jsonpath='{.spec.template.spec.containers[0].resources.limits}'`
  requests=`kubectl get deploy $DEPLOY -n $NS -o=jsonpath='{.spec.template.spec.containers[0].resources.requests}'`
done
</pre>
<hr>


<a id=自动巡检></a>
<h1>自动巡检<h1>

<a id=定期巡检k8s集群运行状态></a>
<h2>定期巡检k8s集群运行状态<h2>


关于自动巡检脚本在是国电通项目上的一个需求，目前国电通项目整体只有k8s集群是使用的我们的，其他部分都是其他公司，为了保证能到巡检k8s集群运行状态，就结合ansible, shell, crond定时计划任务，实现了一套简单的循检脚本，每隔半个小时执行一次，汇总集群主机状态，k8s运行状态等结果， 具体代码可参考　https://github.com/panhaitao/SoldierSuit/tree/master/alauda-k8s-check

<pre>
alauda-k8s-check/
├── etc-crontabs-example        #定时计划任务参考配置
├── k8s-cluster-report-ana.sh　 #分析巡检脚本，汇总巡检结果
├── k8s-cluster-runtasks.sh     #定时计划任务执行的脚本
├── scripts
│   ├── check_k8s_cluser.sh　　 # ansible要执行的用于检查k8s集群状态的脚本
│   └── check_system_stat.sh　　# ansible要执行的用于检查系统运行状态的脚本
└── tasks　　　　　　　　　　　 #考虑到要检查不同的集群，需要分别汇总不同集群的结果
    ├── check_e-cluster.sh　　　#检查e集群需要执行的ansible任务列表
    ├── check_p-cluster.sh　　　#检查p集群需要执行的ansbile任务列表
├── report　　　　　　　　　　　#用于存放汇总后结果
├── result　　　　　　　　　　　#用于存放执行过程的巡检结果
</pre>
      </div>
      
      <div id="right">
        <ul>
	  目录
	  </br>
	  <hr>
	  <li><a href="#议题背景">议题背景</a></li>
	  <li><a href="#主机操作">主机操作</a></li>
          <li><a href="#找出分区占用过大的主机">找出分区占用过大的主机</a></li>
          <li><a href="#查看所有主机运行状态">查看所有主机运行状态</a></li> 
	  <li><a href="#为所有主机添加SSH-key">为所有主机添加SSH-key</a></li>
          <li><a href="#集群">集群</a></li> 
	  <li><a href="#批量重启集群内所有服务">批量重启集群内所有服务</a></li>
	  <li><a href="#启/停部分节点的日志服务">启/停部分节点的日志服务</a></li>
	  <li><a href="#自动巡检">自动巡检</a></li>
	  <li><a href="#定期巡检k8s集群运行状态">定期巡检k8s集群运行状态</a></li>
	</ul>
	  </div>
	</div>
<hr>

</body>

</html>
